/**
 * Initialize Database Schema
 * Automatically creates all tables from SQL files in migrations/schema/
 * 
 * Usage: node init-schema.js
 */

const Database = require('better-sqlite3'); // note: no .verbose()
const path = require('path');
const { createAllTables, verifyTables } = require('./src/utils/schemamanager');

const dbPath = path.join(__dirname, 'data', 'pi.db');
const schemaDir = path.join(__dirname, 'migrations', 'schema');

console.log('ğŸš€ Database Schema Initializer\n');
console.log('Database:', dbPath);
console.log('Schema Directory:', schemaDir);
console.log('='.repeat(50) + '\n');

let db;

try {
  // Open database (synchronous)
  db = new Database(dbPath);
  console.log('âœ… Connected to database.\n');

  // Create all tables from schema files (synchronous)
  const results = createAllTables(db, schemaDir);

  // Verify tables were created (synchronous)
  verifyTables(db);

  console.log('âœ… Database schema initialization complete!\n');

  if (results.failed > 0) {
    console.log('âš ï¸  Some tables failed to create. Check the errors above.');
    process.exit(1);
  }
} catch (error) {
  console.error('âŒ Fatal error:', error);
  process.exit(1);
} finally {
  if (db) {
    db.close();
    console.log('ğŸ›‘ Database connection closed.');
  }
}