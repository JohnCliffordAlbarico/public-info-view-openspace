/**
 * Schema Manager (Better-SQLite3 Version)
 * Automatically creates database tables from SQL schema files
 */

const fs = require('fs');
const path = require('path');

/**
 * Read all SQL files from the schema directory
 * @param {string} schemaDir - Path to schema directory
 * @returns {Array} Array of {filename, sql} objects
 */
function readSchemaFiles(schemaDir) {
  const files = fs.readdirSync(schemaDir);
  const sqlFiles = files.filter(file => file.endsWith('.sql') && file !== 'README.md');

  return sqlFiles.map(file => {
    const filePath = path.join(schemaDir, file);
    const sql = fs.readFileSync(filePath, 'utf8');
    return { filename: file, sql };
  });
}

/**
 * Execute a SQL schema file (synchronous)
 * @param {Object} db - Better-SQLite3 database connection
 * @param {string} filename - SQL file name
 * @param {string} sql - SQL content
 * @returns {Object} Result info
 */
function executeSchema(db, filename, sql) {
  // Remove comments and empty lines
  const cleanSQL = sql
    .split('\n')
    .filter(line => !line.trim().startsWith('--') && line.trim() !== '')
    .join('\n')
    .trim();

  if (!cleanSQL) {
    return { filename, status: 'skipped', message: 'Empty or comment-only file' };
  }

  try {
    db.exec(cleanSQL); // synchronous execution
    // Extract table name from CREATE TABLE statement
    const tableMatch = cleanSQL.match(/CREATE TABLE (?:IF NOT EXISTS )?(\w+)/i);
    const tableName = tableMatch ? tableMatch[1] : 'unknown';
    return { filename, tableName, status: 'success' };
  } catch (err) {
    return { filename, status: 'failed', error: err.message };
  }
}

/**
 * Create all tables from schema files (synchronous)
 * @param {Object} db - Better-SQLite3 database connection
 * @param {string} schemaDir - Path to schema directory
 * @returns {Object} Summary of results
 */
function createAllTables(db, schemaDir) {
  console.log('ðŸ“‹ Schema Manager: Reading schema files...\n');

  const schemaFiles = readSchemaFiles(schemaDir);

  if (schemaFiles.length === 0) {
    console.log('âš ï¸  No SQL schema files found in', schemaDir);
    return { success: 0, failed: 0, skipped: 0, details: [] };
  }

  console.log(`Found ${schemaFiles.length} schema file(s):\n`);

  const results = {
    success: 0,
    failed: 0,
    skipped: 0,
    details: []
  };

  for (const { filename, sql } of schemaFiles) {
    const result = executeSchema(db, filename, sql);

    if (result.status === 'success') {
      console.log(`âœ… ${filename} â†’ Table '${result.tableName}' created`);
      results.success++;
    } else if (result.status === 'skipped') {
      console.log(`â­ï¸  ${filename} â†’ ${result.message}`);
      results.skipped++;
    } else if (result.status === 'failed') {
      console.log(`âŒ ${filename} â†’ Error: ${result.error}`);
      results.failed++;
    }

    results.details.push(result);
  }

  console.log('\n' + '='.repeat(50));
  console.log(`ðŸ“Š Summary: ${results.success} created, ${results.failed} failed, ${results.skipped} skipped`);
  console.log('='.repeat(50) + '\n');

  return results;
}

/**
 * Verify all tables exist in the database (synchronous)
 * @param {Object} db - Better-SQLite3 database connection
 */
function verifyTables(db) {
  const tables = db.prepare("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name").all();

  console.log('ðŸ“‹ Tables in database:');
  tables.forEach(table => console.log(`   - ${table.name}`));
  console.log('');

  return tables;
}

module.exports = {
  readSchemaFiles,
  executeSchema,
  createAllTables,
  verifyTables
};